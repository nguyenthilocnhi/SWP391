<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thanh Toán VNPAY</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .payment-container {
      background-color: white;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 400px;
      width: 100%;
    }

    .payment-container h2 {
      margin-bottom: 20px;
      color: #005baa;
    }

    .qr-code {
      margin: 20px 0;
    }

    .qr-code img {
      width: 220px;
      height: 220px;
      border: 1px solid #ccc;
    }

    .info {
      font-size: 16px;
      margin-top: 10px;
      color: #333;
    }

    .note {
      color: #888;
      font-size: 13px;
      margin-top: 10px;
    }

    .btn-back {
      display: inline-block;
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #005baa;
      color: white;
      border: none;
      border-radius: 6px;
      text-decoration: none;
    }
  </style>
</head>

<body>
  <div class="payment-container">
    <h2>Quét Mã QR để Thanh Toán</h2>
    <div class="qr-code">
      <!-- Đây là QR demo, thay bằng API VNPAY trong thực tế -->
      <img src="https://img.vietqr.io/image/970436-123456789-compact.png?amount=100000&addInfo=THANHTOAN" alt="QR VNPAY">
    </div>
    <div class="info">
      <p><strong>Số tiền:</strong> 100.000 VNĐ</p>
      <p><strong>Nội dung:</strong> THANHTOAN</p>
    </div>
    <div class="note" id="countdown-timer">
      Thời gian còn lại để thanh toán: <span id="timer">05:00</span>
    </div>
    <button class="btn-back" id="btn-cancel" type="button">Hủy</button>
    <button class="btn-back" id="btn-download-qr" type="button" style="background-color: #28a745; margin-left: 10px;">Tải mã QR</button>
    <button class="btn-back" id="btn-paid" type="button" style="background-color: #007bff; margin-left: 10px;">Tôi đã thanh toán</button>
  </div>

  <script>
    // Lấy danh sách lịch đặt, lấy lịch cuối cùng (vừa đặt)
    const danhSach = JSON.parse(localStorage.getItem("lichDat")) || [];
    const lichMoiNhat = danhSach[danhSach.length - 1] || {};

    // Lấy số tiền và nội dung
    // Bảng giá giống bên DatlichXetNghiem.html
    const bangGia = {
      "HIV Ag/Ab combo (HIV test thế hệ 4)": 200000,
      "Giang mai (RPR/TPHA)": 180000,
      "Lậu (PCR hoặc nhuộm soi)": 220000,
      "Chlamydia(PCR)": 210000,
      "HPV": 250000,
      "Virus Zika": 230000,
      "Pap smear": 190000,
      "Sùi mào gà(HPV tuýp nguy cơ thấp)": 240000,
      "Herpes Simplex Virus": 200000,
      "Hạ cam mềm": 170000,
      "Rận mu": 160000
    };
    const loai = lichMoiNhat.loaiXetNghiem || "";
    const soTien = bangGia[loai] || 100000;
    const noiDung = loai ? `Thanh toán ${loai}` : "THANHTOAN";

    // Hàm loại bỏ dấu tiếng Việt
    function removeVietnameseTones(str) {
      return str
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu, '')
        .replace(/đ/g, 'd').replace(/Đ/g, 'D')
        .replace(/[^a-zA-Z0-9 ]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    }

    const noiDungKhongDau = removeVietnameseTones(noiDung);

    // Cập nhật số tiền và nội dung trên giao diện
    const infoPs = document.querySelectorAll('.info p');
    if (infoPs.length >= 2) {
      infoPs[0].innerHTML = `<strong>Số tiền:</strong> ${soTien.toLocaleString('vi-VN')} VNĐ`;
      infoPs[1].innerHTML = `<strong>Nội dung:</strong> ${noiDungKhongDau}`;
    }

    // Cập nhật QR code (nếu API cho phép truyền amount, info)
    const qrImg = document.querySelector('.qr-code img');
    if (qrImg) {
      qrImg.src = `https://img.vietqr.io/image/970436-123456789-compact.png?amount=${soTien}&addInfo=${encodeURIComponent(noiDungKhongDau)}`;
    }

    // Đếm ngược 5 phút
    let timeLeft = 5 * 60; // 5 phút tính bằng giây
    const timerSpan = document.getElementById('timer');
    const countdown = setInterval(() => {
      const min = Math.floor(timeLeft / 60).toString().padStart(2, '0');
      const sec = (timeLeft % 60).toString().padStart(2, '0');
      timerSpan.textContent = `${min}:${sec}`;
      if (timeLeft <= 0) {
        clearInterval(countdown);
        alert('Đã hết thời gian thanh toán! Vui lòng đặt lại lịch.');
        window.location.href = 'DatlichXetNghiem.html';
      }
      timeLeft--;
    }, 1000);

    // Xử lý nút Hủy
    document.getElementById('btn-cancel').onclick = function() {
      if (confirm('Bạn có chắc muốn hủy thanh toán và quay lại đặt lịch?')) {
        window.location.href = 'DatlichXetNghiem.html';
      }
    };

    // Xử lý nút tải mã QR
    document.getElementById('btn-download-qr').onclick = function() {
      const qrImg = document.querySelector('.qr-code img');
      if (qrImg && qrImg.src) {
        const link = document.createElement('a');
        link.href = qrImg.src;
        link.download = 'qr-vnpay.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } else {
        alert('Không tìm thấy mã QR để tải!');
      }
    };

    // Xử lý nút Tôi đã thanh toán
    document.getElementById('btn-paid').onclick = function() {
      // Lấy lịch đặt mới nhất từ localStorage
      const danhSach = JSON.parse(localStorage.getItem("lichDat")) || [];
      const lichMoiNhat = danhSach[danhSach.length - 1];

      if (lichMoiNhat) {
        // Tạo bản ghi cho lịch sử đặt lịch
        const lichSu = JSON.parse(localStorage.getItem("lichSuDatLich")) || [];
        lichSu.push({
          ngay: lichMoiNhat.ngay || "",
          dichVu: lichMoiNhat.loaiXetNghiem || lichMoiNhat.dichVu || "",
          lyDo: lichMoiNhat.lyDo || "",
          hoTen: lichMoiNhat.hoTen || "",
          sdt: lichMoiNhat.sdt || "",
          trangThai: "Đã xác nhận"
        });
        localStorage.setItem("lichSuDatLich", JSON.stringify(lichSu));
      }

      alert('Thanh toán thành công!');
      window.location.href = 'Thanhcongdatlich.html';
    };
  </script>
</body>

</html>
